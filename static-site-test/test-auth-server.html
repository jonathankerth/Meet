<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="x-ua-compatible" content="ie=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />

		<title>Test Auth Server</title>
	</head>

	<body>
		<style>
			#container {
				max-width: 500px;
			}
			h4 {
				margin-top: 25px;
			}
		</style>

		<main id="container">
			<h1>OAuth2 Test</h1>
			<h4><b>Step 1:</b> Get the OAuth URL</h4>
			<p>Click the button below to get your OAuth URL.</p>
			<button id="getURL">Get OAuth URL</button>
			<p id="result"></p>
			<a id="authURL" href target="_blank">Click to authorize</a>
			<!-- STEP 2 -- MAKE SURE STEP 1 WORKS BEFORE MOVING ON-->

			<h4>Step 2: Get your code and exchange for an access token</h4>
			<p>
				After youâ€™re redirected back to your Meet app on GitHub, copy the code
				from the URI.
			</p>
			<!-- STEP 3 -- MAKE SURE STEP 3 WORKS BEFORE MOVING ON-->
			<h4>Step 3: Get the calendar events using your access token</h4>
			<button id="getEvents">Get Events</button>
			<p id="events"></p>
			<br />
			<label
				>Code input
				<input id="code" type="text" value="" />
			</label>
			<button id="getToken">Get Token</button>
			<p id="accessToken"></p>
		</main>
		<script type="text/javascript">
			// --------------------- STEP 1
			const getURLElement = document.getElementById("getURL");
			const resultElement = document.getElementById("result");
			const resultLink = document.getElementById("authURL");
			// Replace this with your own endpoint
			const getAuthURL =
				"https://syovtibn2nrvwpptbxfuez53ii0mvjaq.lambda-url.us-east-1.on.aws/";

			getURLElement.onclick = function () {
				fetch(getAuthURL)
					.then(function (response) {
						if (!response.ok) {
							throw new Error(`HTTP error! status: ${response.status}`);
						}
						return response.json();
					})
					.then(function (json) {
						const result = JSON.stringify(json);
						// we get the value of authUrl
						const { authUrl } = JSON.parse(result);
						// then add it to the html
						resultElement.innerText = result;
						resultLink.href = authUrl;
					})
					.catch(function (error) {
						console.error(
							"There was a problem with the fetch operation: ",
							error
						);
					});
			};
			// --------------------- END OF STEP 1

			// --------------------- STEP 2
			const codeValue = document.getElementById("code");
			const getAccessToken = document.getElementById("getToken");
			const accessTokenElement = document.getElementById("accessToken");
			const getToken =
				"https://les6ejvgz6hmi5lycj22tbufbm0emrlg.lambda-url.us-east-1.on.aws/";

			getAccessToken.onclick = function () {
				let code = codeValue.value;
				const getTokenRequest = getToken + "/" + code;
				fetch(getTokenRequest)
					.then(function (response) {
						if (!response.ok) {
							throw new Error(`HTTP error! status: ${response.status}`);
						}
						return response.json();
					})
					.then(function (json) {
						accessTokenElement.innerText = JSON.stringify(json);
					})
					.catch(function (error) {
						console.error(
							"There was a problem with the fetch operation: ",
							error
						);
					});
			};
			// --------------------- END OF STEP 2
			// -- STEP 3
			const getEvents = document.getElementById("getEvents");
			const events = document.getElementById("events");
			const getCalendarEvents =
				"https://ezkyhskklwyt4mwdeadlecxegu0obbvq.lambda-url.us-east-1.on.aws/";

			getEvents.onclick = function () {
				if (accessTokenElement.innerText.trim() === "") {
					console.error("Access token is not set.");
					return;
				}

				let parsedToken;
				try {
					parsedToken = JSON.parse(accessTokenElement.innerText);
				} catch (err) {
					console.error("Invalid access token format:", err);
					return;
				}

				const { access_token } = parsedToken;
				const eventRequest = getCalendarEvents + "/" + access_token;
				fetch(eventRequest)
					.then(function (response) {
						if (!response.ok) {
							throw new Error(`HTTP error! status: ${response.status}`);
						}
						return response.json();
					})
					.then(function (json) {
						events.innerText = JSON.stringify(json, null, 2);
					})
					.catch(function (error) {
						console.error(
							"There was a problem with the fetch operation: ",
							error
						);
					});
			};

			// -- END OF STEP 3
		</script>
		<script type="text/javascript">
			function handleRedirect() {
				// Get the current URL
				const url = new URL(window.location.href);

				// Extract the code from the URL
				const code = url.searchParams.get("code");

				// Check if a code was found
				if (code) {
					// Update the 'code' input field with the code
					document.getElementById("code").value = code;
				}
			}

			// Call the handleRedirect function when the page loads
			window.onload = handleRedirect;
		</script>
	</body>
</html>
